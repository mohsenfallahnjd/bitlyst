---
title: "Microtask vs Macrotask in JavaScript â€” With Node.js vs Browser Notes"
summary: "Understand microtasks and macrotasks across browsers and Node.js, including process.nextTick, setImmediate, and event loop phases."
publishedTime: "2025-09-20"
tags: ["javascript", "event-loop", "microtask", "macrotask", "nodejs", "browser"]
---


## Recap (Browser)

- **Microtasks**: `Promise.then/catch/finally`, `queueMicrotask`, `MutationObserver`  
- **Macrotasks**: `setTimeout`, `setInterval`, `requestAnimationFrame`, DOM events  
- **Order per tick**: run script â†’ **drain all microtasks** â†’ possibly render â†’ then the next **macrotask**.

---

## Node.js Event Loop Differences

Node.js has **phases** in its event loop (simplified):

1) **Timers** â†’ `setTimeout` / `setInterval` callbacks  
2) **Pending Callbacks**  
3) **Poll** â†’ I/O callbacks; may block waiting for I/O  
4) **Check** â†’ `setImmediate` callbacks  
5) **Close Callbacks**

After each phase, Node runs microtask queues in this order:

- **`process.nextTick`** queue (âœ… runs *before* promise microtasks)
- **Promise microtasks** (jobs scheduled by `Promise.then` / `queueMicrotask`)

### Key takeaways

- `process.nextTick` **always runs before** other microtasks and **before** moving to the next phase. Overuse can **starve** the loop.  
- `setImmediate` runs in the **Check** phase.  
- `setTimeout(..., 0)` runs in the **Timers** phase of a **later** tick.  
- Order of `setTimeout(â€¦,0)` vs `setImmediate` can vary:  
  - After I/O, **`setImmediate` tends to run first** (since the loop is already at the Check phase).  
  - Without I/O, **timers may run first** (implementation- and timing-dependent).

---

## Example: Node.js ordering

```js
// node-order.js
setTimeout(() => console.log('timeout'), 0);
setImmediate(() => console.log('immediate'));
Promise.resolve().then(() => console.log('promise microtask'));
process.nextTick(() => console.log('nextTick microtask'));
```

**Typical Node output:**

```
nextTick microtask
promise microtask
[ either 'immediate' or 'timeout' first, scenario-dependent ]
```

Why:
- `process.nextTick` runs **before** other microtasks.
- Promise microtasks run next.
- Then the loop continues to a phase where either `setImmediate` or `setTimeout` fires first.

> Tip: If you place the scheduling **inside an I/O callback** (e.g., `fs.readFile`), `setImmediate` is more likely to run before `setTimeout`.

---

## Example: Browser ordering

```html
<script>
  setTimeout(() => console.log('timeout'), 0);
  Promise.resolve().then(() => console.log('promise microtask'));
  // process.nextTick / setImmediate are Node-only
</script>
```

**Browser output:**
```
promise microtask
timeout
```

---

## Quick Matrix

| API / Concept           | Browser Microtask | Browser Macrotask | Node Microtask | Node Macrotask |
|-------------------------|-------------------|-------------------|----------------|----------------|
| `Promise.then`          | âœ”ï¸                | âŒ                | âœ”ï¸             | âŒ             |
| `queueMicrotask`        | âœ”ï¸                | âŒ                | âœ”ï¸             | âŒ             |
| `MutationObserver`      | âœ”ï¸                | âŒ                | âŒ (browser only) | âŒ          |
| `setTimeout / setInterval` | âŒ             | âœ”ï¸                | âŒ             | âœ”ï¸ (Timers)    |
| `requestAnimationFrame` | âŒ                | âœ”ï¸ (render step)  | âŒ             | âŒ             |
| `setImmediate`          | âŒ                | âŒ                | âŒ             | âœ”ï¸ (Check)     |
| `process.nextTick`      | âŒ                | âŒ                | âœ”ï¸ (before other microtasks) | âŒ |

---

## Mental Model ğŸ§ 

- **Browser**: script â†’ **microtasks** (Promises) â†’ **macrotask** (timeout) â†’ render.  
- **Node**: phase â†’ **nextTick** â†’ **Promise microtasks** â†’ next phase; `setImmediate` in **Check**, timers in **Timers**.

Use `process.nextTick` sparingly (itâ€™s *too* eager), and prefer Promise microtasks for normal â€œrun right afterâ€ semantics.

---

# Microtask vs Macrotask â€” Visual Diagram

This diagram shows how a **microtask** (Promise) runs **before** a **macrotask** (`setTimeout`) after the script finishes.

![Microtask vs Macrotask â€” Visual Diagram](/assets/microtask-macrotask-diagram.svg)

---

Thatâ€™s it â€” now you can reason about microtasks/macrotasks across both environments with confidence.
